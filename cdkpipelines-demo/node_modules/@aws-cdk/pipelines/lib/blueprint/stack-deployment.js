"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StackDeployment = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const path = require("path");
const url_1 = require("url");
const cxapi = require("@aws-cdk/cx-api");
const asset_manifest_1 = require("../private/asset-manifest");
const cloud_assembly_internals_1 = require("../private/cloud-assembly-internals");
const asset_type_1 = require("./asset-type");
/**
 * Deployment of a single Stack
 *
 * You don't need to instantiate this class -- it will
 * be automatically instantiated as necessary when you
 * add a `Stage` to a pipeline.
 */
class StackDeployment {
    constructor(props) {
        var _b, _c;
        /**
         * Other stacks this stack depends on
         */
        this.stackDependencies = [];
        /**
         * Steps that take place before stack is prepared. If your pipeline engine disables 'prepareStep', then this will happen before stack deploys
         */
        this.pre = [];
        /**
         * Steps that take place after stack is prepared but before stack deploys. Your pipeline engine may not disable `prepareStep`.
         */
        this.changeSet = [];
        /**
         * Steps to execute after stack deploys
         */
        this.post = [];
        this.stackArtifactId = props.stackArtifactId;
        this.constructPath = props.constructPath;
        this.account = props.account;
        this.region = props.region;
        this.tags = (_b = props.tags) !== null && _b !== void 0 ? _b : {};
        this.assumeRoleArn = props.assumeRoleArn;
        this.executionRoleArn = props.executionRoleArn;
        this.stackName = props.stackName;
        this.absoluteTemplatePath = props.absoluteTemplatePath;
        this.templateUrl = props.templateS3Uri ? s3UrlFromUri(props.templateS3Uri, props.region) : undefined;
        this.assets = new Array();
        for (const asset of (_c = props.assets) !== null && _c !== void 0 ? _c : []) {
            if (asset.isTemplate) {
                this.templateAsset = asset;
            }
            else {
                this.assets.push(asset);
            }
        }
    }
    /**
     * Build a `StackDeployment` from a Stack Artifact in a Cloud Assembly.
     */
    static fromArtifact(stackArtifact) {
        const artRegion = stackArtifact.environment.region;
        const region = artRegion === cxapi.UNKNOWN_REGION ? undefined : artRegion;
        const artAccount = stackArtifact.environment.account;
        const account = artAccount === cxapi.UNKNOWN_ACCOUNT ? undefined : artAccount;
        return new StackDeployment({
            account,
            region,
            tags: stackArtifact.tags,
            stackArtifactId: stackArtifact.id,
            constructPath: stackArtifact.hierarchicalId,
            stackName: stackArtifact.stackName,
            absoluteTemplatePath: path.join(stackArtifact.assembly.directory, stackArtifact.templateFile),
            assumeRoleArn: stackArtifact.assumeRoleArn,
            executionRoleArn: stackArtifact.cloudFormationExecutionRoleArn,
            assets: extractStackAssets(stackArtifact),
            templateS3Uri: stackArtifact.stackTemplateAssetObjectUrl,
        });
    }
    /**
     * Add a dependency on another stack
     */
    addStackDependency(stackDeployment) {
        jsiiDeprecationWarnings._aws_cdk_pipelines_StackDeployment(stackDeployment);
        this.stackDependencies.push(stackDeployment);
    }
    /**
     * Adds steps to each phase of the stack
     * @param pre steps executed before stack.prepare
     * @param changeSet steps executed after stack.prepare and before stack.deploy
     * @param post steps executed after stack.deploy
     */
    addStackSteps(pre, changeSet, post) {
        this.pre.push(...pre);
        this.changeSet.push(...changeSet);
        this.post.push(...post);
    }
}
exports.StackDeployment = StackDeployment;
_a = JSII_RTTI_SYMBOL_1;
StackDeployment[_a] = { fqn: "@aws-cdk/pipelines.StackDeployment", version: "1.148.0" };
function extractStackAssets(stackArtifact) {
    const ret = new Array();
    const assetManifests = stackArtifact.dependencies.filter(cloud_assembly_internals_1.isAssetManifest);
    for (const manifestArtifact of assetManifests) {
        const manifest = asset_manifest_1.AssetManifestReader.fromFile(manifestArtifact.file);
        for (const entry of manifest.entries) {
            let assetType;
            let isTemplate = false;
            if (entry instanceof asset_manifest_1.DockerImageManifestEntry) {
                assetType = asset_type_1.AssetType.DOCKER_IMAGE;
            }
            else if (entry instanceof asset_manifest_1.FileManifestEntry) {
                isTemplate = entry.source.packaging === 'file' && entry.source.path === stackArtifact.templateFile;
                assetType = asset_type_1.AssetType.FILE;
            }
            else {
                throw new Error(`Unrecognized asset type: ${entry.type}`);
            }
            ret.push({
                assetManifestPath: manifestArtifact.file,
                assetId: entry.id.assetId,
                assetSelector: entry.id.toString(),
                assetType,
                assetPublishingRoleArn: entry.destination.assumeRoleArn,
                isTemplate,
            });
        }
    }
    return ret;
}
/**
 * Takes an s3://bucket/object-key uri and returns a region-aware https:// url for it
 *
 * @param uri The s3 URI
 * @param region The region (if undefined, we will return the global endpoint)
 * @see https://docs.aws.amazon.com/AmazonS3/latest/userguide/VirtualHosting.html#virtual-hosted-style-access
 */
function s3UrlFromUri(uri, region) {
    const url = url_1.parse(uri);
    return `https://${url.hostname}.s3.${region ? `${region}.` : ''}amazonaws.com${url.path}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stZGVwbG95bWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YWNrLWRlcGxveW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNkJBQTZCO0FBQzdCLDZCQUF3QztBQUN4Qyx5Q0FBeUM7QUFDekMsOERBQTZHO0FBQzdHLGtGQUFzRTtBQUN0RSw2Q0FBeUM7QUE4RXpDOzs7Ozs7R0FNRztBQUNILE1BQWEsZUFBZTtJQXVIMUIsWUFBb0IsS0FBMkI7O1FBekMvQzs7V0FFRztRQUNhLHNCQUFpQixHQUFzQixFQUFFLENBQUM7UUF1QjFEOztXQUVHO1FBQ2EsUUFBRyxHQUFXLEVBQUUsQ0FBQztRQUVqQzs7V0FFRztRQUNhLGNBQVMsR0FBVyxFQUFFLENBQUM7UUFFdkM7O1dBRUc7UUFDYSxTQUFJLEdBQVcsRUFBRSxDQUFDO1FBR2hDLElBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQztRQUM3QyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7UUFDekMsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUMzQixJQUFJLENBQUMsSUFBSSxTQUFHLEtBQUssQ0FBQyxJQUFJLG1DQUFJLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7UUFDekMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQztRQUMvQyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDakMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztRQUN2RCxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FB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Q0FBQyxZQUFZLENBQUM7YUFDcEM7aUJBQU0sSUFBSSxLQUFLLFlBQVksa0NBQWlCLEVBQUU7Z0JBQzdDLFVBQVUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsS0FBSyxNQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLFlBQVksQ0FBQztnQkFDbkcsU0FBUyxHQUFHLHNCQUFTLENBQUMsSUFBSSxDQUFDO2FBQzVCO2lCQUFNO2dCQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQzNEO1lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxpQkFBaUIsRUFBRSxnQkFBZ0IsQ0FBQyxJQUFJO2dCQUN4QyxPQUFPLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPO2dCQUN6QixhQUFhLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xDLFNBQVM7Z0JBQ1Qsc0JBQXNCLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhO2dCQUN2RCxVQUFVO2FBQ1gsQ0FBQyxDQUFDO1NBQ0o7S0FDRjtJQUVELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUVEOzs7Ozs7R0FNRztBQUNILFNBQVMsWUFBWSxDQUFDLEdBQVcsRUFBRSxNQUEwQjtJQUMzRCxNQUFNLEdBQUcsR0FBRyxXQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDMUIsT0FBTyxXQUFXLEdBQUcsQ0FBQyxRQUFRLE9BQU8sTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLGdCQUFnQixHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDNUYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBwYXJzZSBhcyBwYXJzZVVybCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgQXNzZXRNYW5pZmVzdFJlYWRlciwgRG9ja2VySW1hZ2VNYW5pZmVzdEVudHJ5LCBGaWxlTWFuaWZlc3RFbnRyeSB9IGZyb20gJy4uL3ByaXZhdGUvYXNzZXQtbWFuaWZlc3QnO1xuaW1wb3J0IHsgaXNBc3NldE1hbmlmZXN0IH0gZnJvbSAnLi4vcHJpdmF0ZS9jbG91ZC1hc3NlbWJseS1pbnRlcm5hbHMnO1xuaW1wb3J0IHsgQXNzZXRUeXBlIH0gZnJvbSAnLi9hc3NldC10eXBlJztcbmltcG9ydCB7IFN0ZXAgfSBmcm9tICcuL3N0ZXAnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGEgYFN0YWNrRGVwbG95bWVudGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdGFja0RlcGxveW1lbnRQcm9wcyB7XG4gIC8qKlxuICAgKiBBcnRpZmFjdCBJRCBmb3IgdGhpcyBzdGFja1xuICAgKi9cbiAgcmVhZG9ubHkgc3RhY2tBcnRpZmFjdElkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdCBwYXRoIGZvciB0aGlzIHN0YWNrXG4gICAqL1xuICByZWFkb25seSBjb25zdHJ1Y3RQYXRoOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIE5hbWUgZm9yIHRoaXMgc3RhY2tcbiAgICovXG4gIHJlYWRvbmx5IHN0YWNrTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBSZWdpb24gd2hlcmUgdGhlIHN0YWNrIHNob3VsZCBiZSBkZXBsb3llZFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFBpcGVsaW5lIHJlZ2lvblxuICAgKi9cbiAgcmVhZG9ubHkgcmVnaW9uPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBY2NvdW50IHdoZXJlIHRoZSBzdGFjayBzaG91bGQgYmUgZGVwbG95ZWRcbiAgICpcbiAgICogQGRlZmF1bHQgLSBQaXBlbGluZSBhY2NvdW50XG4gICAqL1xuICByZWFkb25seSBhY2NvdW50Pzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBSb2xlIHRvIGFzc3VtZSBiZWZvcmUgZGVwbG95aW5nIHRoaXMgc3RhY2tcbiAgICpcbiAgICogQGRlZmF1bHQgLSBEb24ndCBhc3N1bWUgYW55IHJvbGVcbiAgICovXG4gIHJlYWRvbmx5IGFzc3VtZVJvbGVBcm4/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGlvbiByb2xlIHRvIHBhc3MgdG8gQ2xvdWRGb3JtYXRpb25cbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyBleGVjdXRpb24gcm9sZVxuICAgKi9cbiAgcmVhZG9ubHkgZXhlY3V0aW9uUm9sZUFybj86IHN0cmluZztcblxuICAvKipcbiAgICogVGFncyB0byBhcHBseSB0byB0aGUgc3RhY2tcbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyB0YWdzXG4gICAqL1xuICByZWFkb25seSB0YWdzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuICAvKipcbiAgICogVGVtcGxhdGUgcGF0aCBvbiBkaXNrIHRvIGNsb3VkIGFzc2VtYmx5IChjZGsub3V0KVxuICAgKi9cbiAgcmVhZG9ubHkgYWJzb2x1dGVUZW1wbGF0ZVBhdGg6IHN0cmluZztcblxuICAvKipcbiAgICogQXNzZXRzIHJlZmVyZW5jZWQgYnkgdGhpcyBzdGFja1xuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIGFzc2V0c1xuICAgKi9cbiAgcmVhZG9ubHkgYXNzZXRzPzogU3RhY2tBc3NldFtdO1xuXG4gIC8qKlxuICAgKiBUaGUgUzMgVVJMIHdoaWNoIHBvaW50cyB0byB0aGUgdGVtcGxhdGUgYXNzZXQgbG9jYXRpb24gaW4gdGhlIHB1Ymxpc2hpbmdcbiAgICogYnVja2V0LlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFN0YWNrIHRlbXBsYXRlIGlzIG5vdCBwdWJsaXNoZWRcbiAgICovXG4gIHJlYWRvbmx5IHRlbXBsYXRlUzNVcmk/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogRGVwbG95bWVudCBvZiBhIHNpbmdsZSBTdGFja1xuICpcbiAqIFlvdSBkb24ndCBuZWVkIHRvIGluc3RhbnRpYXRlIHRoaXMgY2xhc3MgLS0gaXQgd2lsbFxuICogYmUgYXV0b21hdGljYWxseSBpbnN0YW50aWF0ZWQgYXMgbmVjZXNzYXJ5IHdoZW4geW91XG4gKiBhZGQgYSBgU3RhZ2VgIHRvIGEgcGlwZWxpbmUuXG4gKi9cbmV4cG9ydCBjbGFzcyBTdGFja0RlcGxveW1lbnQge1xuICAvKipcbiAgICogQnVpbGQgYSBgU3RhY2tEZXBsb3ltZW50YCBmcm9tIGEgU3RhY2sgQXJ0aWZhY3QgaW4gYSBDbG91ZCBBc3NlbWJseS5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbUFydGlmYWN0KHN0YWNrQXJ0aWZhY3Q6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCk6IFN0YWNrRGVwbG95bWVudCB7XG4gICAgY29uc3QgYXJ0UmVnaW9uID0gc3RhY2tBcnRpZmFjdC5lbnZpcm9ubWVudC5yZWdpb247XG4gICAgY29uc3QgcmVnaW9uID0gYXJ0UmVnaW9uID09PSBjeGFwaS5VTktOT1dOX1JFR0lPTiA/IHVuZGVmaW5lZCA6IGFydFJlZ2lvbjtcbiAgICBjb25zdCBhcnRBY2NvdW50ID0gc3RhY2tBcnRpZmFjdC5lbnZpcm9ubWVudC5hY2NvdW50O1xuICAgIGNvbnN0IGFjY291bnQgPSBhcnRBY2NvdW50ID09PSBjeGFwaS5VTktOT1dOX0FDQ09VTlQgPyB1bmRlZmluZWQgOiBhcnRBY2NvdW50O1xuXG4gICAgcmV0dXJuIG5ldyBTdGFja0RlcGxveW1lbnQoe1xuICAgICAgYWNjb3VudCxcbiAgICAgIHJlZ2lvbixcbiAgICAgIHRhZ3M6IHN0YWNrQXJ0aWZhY3QudGFncyxcbiAgICAgIHN0YWNrQXJ0aWZhY3RJZDogc3RhY2tBcnRpZmFjdC5pZCxcbiAgICAgIGNvbnN0cnVjdFBhdGg6IHN0YWNrQXJ0aWZhY3QuaGllcmFyY2hpY2FsSWQsXG4gICAgICBzdGFja05hbWU6IHN0YWNrQXJ0aWZhY3Quc3RhY2tOYW1lLFxuICAgICAgYWJzb2x1dGVUZW1wbGF0ZVBhdGg6IHBhdGguam9pbihzdGFja0FydGlmYWN0LmFzc2VtYmx5LmRpcmVjdG9yeSwgc3RhY2tBcnRpZmFjdC50ZW1wbGF0ZUZpbGUpLFxuICAgICAgYXNzdW1lUm9sZUFybjogc3RhY2tBcnRpZmFjdC5hc3N1bWVSb2xlQXJuLFxuICAgICAgZXhlY3V0aW9uUm9sZUFybjogc3RhY2tBcnRpZmFjdC5jbG91ZEZvcm1hdGlvbkV4ZWN1dGlvblJvbGVBcm4sXG4gICAgICBhc3NldHM6IGV4dHJhY3RTdGFja0Fzc2V0cyhzdGFja0FydGlmYWN0KSxcbiAgICAgIHRlbXBsYXRlUzNVcmk6IHN0YWNrQXJ0aWZhY3Quc3RhY2tUZW1wbGF0ZUFzc2V0T2JqZWN0VXJsLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFydGlmYWN0IElEIGZvciB0aGlzIHN0YWNrXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhY2tBcnRpZmFjdElkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdCBwYXRoIGZvciB0aGlzIHN0YWNrXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgY29uc3RydWN0UGF0aDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBOYW1lIGZvciB0aGlzIHN0YWNrXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhY2tOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFJlZ2lvbiB3aGVyZSB0aGUgc3RhY2sgc2hvdWxkIGJlIGRlcGxveWVkXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gUGlwZWxpbmUgcmVnaW9uXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcmVnaW9uPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBY2NvdW50IHdoZXJlIHRoZSBzdGFjayBzaG91bGQgYmUgZGVwbG95ZWRcbiAgICpcbiAgICogQGRlZmF1bHQgLSBQaXBlbGluZSBhY2NvdW50XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYWNjb3VudD86IHN0cmluZztcblxuICAvKipcbiAgICogUm9sZSB0byBhc3N1bWUgYmVmb3JlIGRlcGxveWluZyB0aGlzIHN0YWNrXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRG9uJ3QgYXNzdW1lIGFueSByb2xlXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYXNzdW1lUm9sZUFybj86IHN0cmluZztcblxuICAvKipcbiAgICogRXhlY3V0aW9uIHJvbGUgdG8gcGFzcyB0byBDbG91ZEZvcm1hdGlvblxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIGV4ZWN1dGlvbiByb2xlXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZXhlY3V0aW9uUm9sZUFybj86IHN0cmluZztcblxuICAvKipcbiAgICogVGFncyB0byBhcHBseSB0byB0aGUgc3RhY2tcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB0YWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIC8qKlxuICAgKiBBc3NldHMgcmVmZXJlbmNlZCBieSB0aGlzIHN0YWNrXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYXNzZXRzOiBTdGFja0Fzc2V0W107XG5cbiAgLyoqXG4gICAqIE90aGVyIHN0YWNrcyB0aGlzIHN0YWNrIGRlcGVuZHMgb25cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBzdGFja0RlcGVuZGVuY2llczogU3RhY2tEZXBsb3ltZW50W10gPSBbXTtcblxuICAvKipcbiAgICogVGhlIGFzc2V0IHRoYXQgcmVwcmVzZW50cyB0aGUgQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgZm9yIHRoaXMgc3RhY2suXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdGVtcGxhdGVBc3NldD86IFN0YWNrQXNzZXQ7XG5cbiAgLyoqXG4gICAqIFRoZSBTMyBVUkwgd2hpY2ggcG9pbnRzIHRvIHRoZSB0ZW1wbGF0ZSBhc3NldCBsb2NhdGlvbiBpbiB0aGUgcHVibGlzaGluZ1xuICAgKiBidWNrZXQuXG4gICAqXG4gICAqIFRoaXMgaXMgYHVuZGVmaW5lZGAgaWYgdGhlIHN0YWNrIHRlbXBsYXRlIGlzIG5vdCBwdWJsaXNoZWQuIFVzZSB0aGVcbiAgICogYERlZmF1bHRTdGFja1N5bnRoZXNpemVyYCB0byBlbnN1cmUgaXQgaXMuXG4gICAqXG4gICAqIEV4YW1wbGUgdmFsdWU6IGBodHRwczovL2J1Y2tldC5zMy5hbWF6b25hd3MuY29tL29iamVjdC9rZXlgXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdGVtcGxhdGVVcmw/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRlbXBsYXRlIHBhdGggb24gZGlzayB0byBDbG91ZEFzc2VtYmx5XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYWJzb2x1dGVUZW1wbGF0ZVBhdGg6IHN0cmluZztcblxuICAvKipcbiAgICogU3RlcHMgdGhhdCB0YWtlIHBsYWNlIGJlZm9yZSBzdGFjayBpcyBwcmVwYXJlZC4gSWYgeW91ciBwaXBlbGluZSBlbmdpbmUgZGlzYWJsZXMgJ3ByZXBhcmVTdGVwJywgdGhlbiB0aGlzIHdpbGwgaGFwcGVuIGJlZm9yZSBzdGFjayBkZXBsb3lzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcHJlOiBTdGVwW10gPSBbXTtcblxuICAvKipcbiAgICogU3RlcHMgdGhhdCB0YWtlIHBsYWNlIGFmdGVyIHN0YWNrIGlzIHByZXBhcmVkIGJ1dCBiZWZvcmUgc3RhY2sgZGVwbG95cy4gWW91ciBwaXBlbGluZSBlbmdpbmUgbWF5IG5vdCBkaXNhYmxlIGBwcmVwYXJlU3RlcGAuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgY2hhbmdlU2V0OiBTdGVwW10gPSBbXTtcblxuICAvKipcbiAgICogU3RlcHMgdG8gZXhlY3V0ZSBhZnRlciBzdGFjayBkZXBsb3lzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcG9zdDogU3RlcFtdID0gW107XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcm9wczogU3RhY2tEZXBsb3ltZW50UHJvcHMpIHtcbiAgICB0aGlzLnN0YWNrQXJ0aWZhY3RJZCA9IHByb3BzLnN0YWNrQXJ0aWZhY3RJZDtcbiAgICB0aGlzLmNvbnN0cnVjdFBhdGggPSBwcm9wcy5jb25zdHJ1Y3RQYXRoO1xuICAgIHRoaXMuYWNjb3VudCA9IHByb3BzLmFjY291bnQ7XG4gICAgdGhpcy5yZWdpb24gPSBwcm9wcy5yZWdpb247XG4gICAgdGhpcy50YWdzID0gcHJvcHMudGFncyA/PyB7fTtcbiAgICB0aGlzLmFzc3VtZVJvbGVBcm4gPSBwcm9wcy5hc3N1bWVSb2xlQXJuO1xuICAgIHRoaXMuZXhlY3V0aW9uUm9sZUFybiA9IHByb3BzLmV4ZWN1dGlvblJvbGVBcm47XG4gICAgdGhpcy5zdGFja05hbWUgPSBwcm9wcy5zdGFja05hbWU7XG4gICAgdGhpcy5hYnNvbHV0ZVRlbXBsYXRlUGF0aCA9IHByb3BzLmFic29sdXRlVGVtcGxhdGVQYXRoO1xuICAgIHRoaXMudGVtcGxhdGVVcmwgPSBwcm9wcy50ZW1wbGF0ZVMzVXJpID8gczNVcmxGcm9tVXJpKHByb3BzLnRlbXBsYXRlUzNVcmksIHByb3BzLnJlZ2lvbikgOiB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLmFzc2V0cyA9IG5ldyBBcnJheTxTdGFja0Fzc2V0PigpO1xuXG4gICAgZm9yIChjb25zdCBhc3NldCBvZiBwcm9wcy5hc3NldHMgPz8gW10pIHtcbiAgICAgIGlmIChhc3NldC5pc1RlbXBsYXRlKSB7XG4gICAgICAgIHRoaXMudGVtcGxhdGVBc3NldCA9IGFzc2V0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hc3NldHMucHVzaChhc3NldCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGRlcGVuZGVuY3kgb24gYW5vdGhlciBzdGFja1xuICAgKi9cbiAgcHVibGljIGFkZFN0YWNrRGVwZW5kZW5jeShzdGFja0RlcGxveW1lbnQ6IFN0YWNrRGVwbG95bWVudCkge1xuICAgIHRoaXMuc3RhY2tEZXBlbmRlbmNpZXMucHVzaChzdGFja0RlcGxveW1lbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgc3RlcHMgdG8gZWFjaCBwaGFzZSBvZiB0aGUgc3RhY2tcbiAgICogQHBhcmFtIHByZSBzdGVwcyBleGVjdXRlZCBiZWZvcmUgc3RhY2sucHJlcGFyZVxuICAgKiBAcGFyYW0gY2hhbmdlU2V0IHN0ZXBzIGV4ZWN1dGVkIGFmdGVyIHN0YWNrLnByZXBhcmUgYW5kIGJlZm9yZSBzdGFjay5kZXBsb3lcbiAgICogQHBhcmFtIHBvc3Qgc3RlcHMgZXhlY3V0ZWQgYWZ0ZXIgc3RhY2suZGVwbG95XG4gICAqL1xuICBwdWJsaWMgYWRkU3RhY2tTdGVwcyhwcmU6IFN0ZXBbXSwgY2hhbmdlU2V0OiBTdGVwW10sIHBvc3Q6IFN0ZXBbXSkge1xuICAgIHRoaXMucHJlLnB1c2goLi4ucHJlKTtcbiAgICB0aGlzLmNoYW5nZVNldC5wdXNoKC4uLmNoYW5nZVNldCk7XG4gICAgdGhpcy5wb3N0LnB1c2goLi4ucG9zdCk7XG4gIH1cbn1cblxuLyoqXG4gKiBBbiBhc3NldCB1c2VkIGJ5IGEgU3RhY2tcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdGFja0Fzc2V0IHtcbiAgLyoqXG4gICAqIEFic29sdXRlIGFzc2V0IG1hbmlmZXN0IHBhdGhcbiAgICpcbiAgICogVGhpcyBuZWVkcyB0byBiZSBtYWRlIHJlbGF0aXZlIGF0IGEgbGF0ZXIgcG9pbnQgaW4gdGltZSwgYnV0IHdoZW4gdGhpc1xuICAgKiBpbmZvcm1hdGlvbiBpcyBwYXJzZWQgd2UgZG9uJ3Qga25vdyBhYm91dCB0aGUgcm9vdCBjbG91ZCBhc3NlbWJseSB5ZXQuXG4gICAqL1xuICByZWFkb25seSBhc3NldE1hbmlmZXN0UGF0aDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBc3NldCBpZGVudGlmaWVyXG4gICAqL1xuICByZWFkb25seSBhc3NldElkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFzc2V0IHNlbGVjdG9yIHRvIHBhc3MgdG8gYGNkay1hc3NldHNgLlxuICAgKi9cbiAgcmVhZG9ubHkgYXNzZXRTZWxlY3Rvcjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUeXBlIG9mIGFzc2V0IHRvIHB1Ymxpc2hcbiAgICovXG4gIHJlYWRvbmx5IGFzc2V0VHlwZTogQXNzZXRUeXBlO1xuXG4gIC8qKlxuICAgKiBSb2xlIEFSTiB0byBhc3N1bWUgdG8gcHVibGlzaFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIG5lZWQgdG8gYXNzdW1lIGFueSByb2xlXG4gICAqL1xuICByZWFkb25seSBhc3NldFB1Ymxpc2hpbmdSb2xlQXJuPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBEb2VzIHRoaXMgYXNzZXQgcmVwcmVzZW50IHRoZSBDbG91ZEZvcm1hdGlvbiB0ZW1wbGF0ZSBmb3IgdGhlIHN0YWNrXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBpc1RlbXBsYXRlOiBib29sZWFuO1xufVxuXG5mdW5jdGlvbiBleHRyYWN0U3RhY2tBc3NldHMoc3RhY2tBcnRpZmFjdDogY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0KTogU3RhY2tBc3NldFtdIHtcbiAgY29uc3QgcmV0ID0gbmV3IEFycmF5PFN0YWNrQXNzZXQ+KCk7XG5cbiAgY29uc3QgYXNzZXRNYW5pZmVzdHMgPSBzdGFja0FydGlmYWN0LmRlcGVuZGVuY2llcy5maWx0ZXIoaXNBc3NldE1hbmlmZXN0KTtcbiAgZm9yIChjb25zdCBtYW5pZmVzdEFydGlmYWN0IG9mIGFzc2V0TWFuaWZlc3RzKSB7XG4gICAgY29uc3QgbWFuaWZlc3QgPSBBc3NldE1hbmlmZXN0UmVhZGVyLmZyb21GaWxlKG1hbmlmZXN0QXJ0aWZhY3QuZmlsZSk7XG5cbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIG1hbmlmZXN0LmVudHJpZXMpIHtcbiAgICAgIGxldCBhc3NldFR5cGU6IEFzc2V0VHlwZTtcbiAgICAgIGxldCBpc1RlbXBsYXRlID0gZmFsc2U7XG5cbiAgICAgIGlmIChlbnRyeSBpbnN0YW5jZW9mIERvY2tlckltYWdlTWFuaWZlc3RFbnRyeSkge1xuICAgICAgICBhc3NldFR5cGUgPSBBc3NldFR5cGUuRE9DS0VSX0lNQUdFO1xuICAgICAgfSBlbHNlIGlmIChlbnRyeSBpbnN0YW5jZW9mIEZpbGVNYW5pZmVzdEVudHJ5KSB7XG4gICAgICAgIGlzVGVtcGxhdGUgPSBlbnRyeS5zb3VyY2UucGFja2FnaW5nID09PSAnZmlsZScgJiYgZW50cnkuc291cmNlLnBhdGggPT09IHN0YWNrQXJ0aWZhY3QudGVtcGxhdGVGaWxlO1xuICAgICAgICBhc3NldFR5cGUgPSBBc3NldFR5cGUuRklMRTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIGFzc2V0IHR5cGU6ICR7ZW50cnkudHlwZX1gKTtcbiAgICAgIH1cblxuICAgICAgcmV0LnB1c2goe1xuICAgICAgICBhc3NldE1hbmlmZXN0UGF0aDogbWFuaWZlc3RBcnRpZmFjdC5maWxlLFxuICAgICAgICBhc3NldElkOiBlbnRyeS5pZC5hc3NldElkLFxuICAgICAgICBhc3NldFNlbGVjdG9yOiBlbnRyeS5pZC50b1N0cmluZygpLFxuICAgICAgICBhc3NldFR5cGUsXG4gICAgICAgIGFzc2V0UHVibGlzaGluZ1JvbGVBcm46IGVudHJ5LmRlc3RpbmF0aW9uLmFzc3VtZVJvbGVBcm4sXG4gICAgICAgIGlzVGVtcGxhdGUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmV0O1xufVxuXG4vKipcbiAqIFRha2VzIGFuIHMzOi8vYnVja2V0L29iamVjdC1rZXkgdXJpIGFuZCByZXR1cm5zIGEgcmVnaW9uLWF3YXJlIGh0dHBzOi8vIHVybCBmb3IgaXRcbiAqXG4gKiBAcGFyYW0gdXJpIFRoZSBzMyBVUklcbiAqIEBwYXJhbSByZWdpb24gVGhlIHJlZ2lvbiAoaWYgdW5kZWZpbmVkLCB3ZSB3aWxsIHJldHVybiB0aGUgZ2xvYmFsIGVuZHBvaW50KVxuICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uUzMvbGF0ZXN0L3VzZXJndWlkZS9WaXJ0dWFsSG9zdGluZy5odG1sI3ZpcnR1YWwtaG9zdGVkLXN0eWxlLWFjY2Vzc1xuICovXG5mdW5jdGlvbiBzM1VybEZyb21VcmkodXJpOiBzdHJpbmcsIHJlZ2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGNvbnN0IHVybCA9IHBhcnNlVXJsKHVyaSk7XG4gIHJldHVybiBgaHR0cHM6Ly8ke3VybC5ob3N0bmFtZX0uczMuJHtyZWdpb24gPyBgJHtyZWdpb259LmAgOiAnJ31hbWF6b25hd3MuY29tJHt1cmwucGF0aH1gO1xufSJdfQ==