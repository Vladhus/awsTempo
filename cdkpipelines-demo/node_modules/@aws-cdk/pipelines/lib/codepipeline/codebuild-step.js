"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CodeBuildStep = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const codebuild = require("@aws-cdk/aws-codebuild");
const blueprint_1 = require("../blueprint");
const buildspecs_1 = require("./private/buildspecs");
const outputs_1 = require("./private/outputs");
/**
 * Run a script as a CodeBuild Project
 *
 * The BuildSpec must be available inline--it cannot reference a file
 * on disk. If your current build instructions are in a file like
 * `buildspec.yml` in your repository, extract them to a script
 * (say, `build.sh`) and invoke that script as part of the build:
 *
 * ```ts
 * new pipelines.CodeBuildStep('Synth', {
 *   commands: ['./build.sh'],
 * });
 * ```
 */
class CodeBuildStep extends blueprint_1.ShellStep {
    constructor(id, props) {
        super(id, props);
        this.exportedVariables = new Set();
        this.exportedVarsRendered = false;
        jsiiDeprecationWarnings._aws_cdk_pipelines_CodeBuildStepProps(props);
        this.projectName = props.projectName;
        this.buildEnvironment = props.buildEnvironment;
        this._partialBuildSpec = props.partialBuildSpec;
        this.vpc = props.vpc;
        this.subnetSelection = props.subnetSelection;
        this.role = props.role;
        this.rolePolicyStatements = props.rolePolicyStatements;
        this.securityGroups = props.securityGroups;
        this.timeout = props.timeout;
    }
    /**
     * CodeBuild Project generated for the pipeline
     *
     * Will only be available after the pipeline has been built.
     */
    get project() {
        if (!this._project) {
            throw new Error('Call pipeline.buildPipeline() before reading this property');
        }
        return this._project;
    }
    /**
     * The CodeBuild Project's principal
     */
    get grantPrincipal() {
        return this.project.grantPrincipal;
    }
    /**
     * Additional configuration that can only be configured via BuildSpec
     *
     * Contains exported variables
     *
     * @default - Contains the exported variables
     */
    get partialBuildSpec() {
        this.exportedVarsRendered = true;
        const varsBuildSpec = this.exportedVariables.size > 0 ? codebuild.BuildSpec.fromObject({
            version: '0.2',
            env: {
                'exported-variables': Array.from(this.exportedVariables),
            },
        }) : undefined;
        return buildspecs_1.mergeBuildSpecs(varsBuildSpec, this._partialBuildSpec);
    }
    /**
     * Reference a CodePipeline variable defined by the CodeBuildStep.
     *
     * The variable must be set in the shell of the CodeBuild step when
     * it finishes its `post_build` phase.
     *
     * @param variableName the name of the variable for reference.
     */
    exportedVariable(variableName) {
        if (this.exportedVarsRendered && !this.exportedVariables.has(variableName)) {
            throw new Error('exportVariable(): Pipeline has already been produced, cannot call this function anymore');
        }
        this.exportedVariables.add(variableName);
        return outputs_1.makeCodePipelineOutput(this, variableName);
    }
    /**
     * Set the internal project value
     *
     * @internal
     */
    _setProject(project) {
        this._project = project;
    }
}
exports.CodeBuildStep = CodeBuildStep;
_a = JSII_RTTI_SYMBOL_1;
CodeBuildStep[_a] = { fqn: "@aws-cdk/pipelines.CodeBuildStep", version: "1.148.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWJ1aWxkLXN0ZXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb2RlYnVpbGQtc3RlcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBb0Q7QUFJcEQsNENBQXlEO0FBQ3pELHFEQUF1RDtBQUN2RCwrQ0FBMkQ7QUE0RjNEOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFDSCxNQUFhLGFBQWMsU0FBUSxxQkFBUztJQWdFMUMsWUFBWSxFQUFVLEVBQUUsS0FBeUI7UUFDL0MsS0FBSyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUpGLHNCQUFpQixHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDL0MseUJBQW9CLEdBQUcsS0FBSyxDQUFDOztRQUtuQyxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7UUFDckMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQztRQUMvQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDO1FBQ2hELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUNyQixJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUM7UUFDN0MsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLENBQUM7UUFDdkQsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDO1FBQzNDLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztLQUM5QjtJQUVEOzs7O09BSUc7SUFDSCxJQUFXLE9BQU87UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyw0REFBNEQsQ0FBQyxDQUFDO1NBQy9FO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0tBQ3RCO0lBRUQ7O09BRUc7SUFDSCxJQUFXLGNBQWM7UUFDdkIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQztLQUNwQztJQUVEOzs7Ozs7T0FNRztJQUNILElBQVcsZ0JBQWdCO1FBQ3pCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUM7UUFFakMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1lBQ3JGLE9BQU8sRUFBRSxLQUFLO1lBQ2QsR0FBRyxFQUFFO2dCQUNILG9CQUFvQixFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDO2FBQ3pEO1NBQ0YsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFZixPQUFPLDRCQUFlLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0tBQy9EO0lBRUQ7Ozs7Ozs7T0FPRztJQUNJLGdCQUFnQixDQUFDLFlBQW9CO1FBQzFDLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUMxRSxNQUFNLElBQUksS0FBSyxDQUFDLHlGQUF5RixDQUFDLENBQUM7U0FDNUc7UUFFRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXpDLE9BQU8sZ0NBQXNCLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQ25EO0lBRUQ7Ozs7T0FJRztJQUNJLFdBQVcsQ0FBQyxPQUEyQjtRQUM1QyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztLQUN6Qjs7QUE5SUgsc0NBK0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY29kZWJ1aWxkIGZyb20gJ0Bhd3MtY2RrL2F3cy1jb2RlYnVpbGQnO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJ0Bhd3MtY2RrL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ0Bhd3MtY2RrL2F3cy1pYW0nO1xuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IFNoZWxsU3RlcCwgU2hlbGxTdGVwUHJvcHMgfSBmcm9tICcuLi9ibHVlcHJpbnQnO1xuaW1wb3J0IHsgbWVyZ2VCdWlsZFNwZWNzIH0gZnJvbSAnLi9wcml2YXRlL2J1aWxkc3BlY3MnO1xuaW1wb3J0IHsgbWFrZUNvZGVQaXBlbGluZU91dHB1dCB9IGZyb20gJy4vcHJpdmF0ZS9vdXRwdXRzJztcblxuLyoqXG4gKiBDb25zdHJ1Y3Rpb24gcHJvcHMgZm9yIGEgQ29kZUJ1aWxkU3RlcFxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvZGVCdWlsZFN0ZXBQcm9wcyBleHRlbmRzIFNoZWxsU3RlcFByb3BzIHtcbiAgLyoqXG4gICAqIE5hbWUgZm9yIHRoZSBnZW5lcmF0ZWQgQ29kZUJ1aWxkIHByb2plY3RcbiAgICpcbiAgICogQGRlZmF1bHQgLSBBdXRvbWF0aWNhbGx5IGdlbmVyYXRlZFxuICAgKi9cbiAgcmVhZG9ubHkgcHJvamVjdE5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiB0aGF0IGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgdmlhIEJ1aWxkU3BlY1xuICAgKlxuICAgKiBZb3Ugc2hvdWxkIG5vdCB1c2UgdGhpcyB0byBzcGVjaWZ5IG91dHB1dCBhcnRpZmFjdHM7IHRob3NlXG4gICAqIHNob3VsZCBiZSBzdXBwbGllZCB2aWEgdGhlIG90aGVyIHByb3BlcnRpZXMgb2YgdGhpcyBjbGFzcywgb3RoZXJ3aXNlXG4gICAqIENESyBQaXBlbGluZXMgd29uJ3QgYmUgYWJsZSB0byBpbnNwZWN0IHRoZSBhcnRpZmFjdHMuXG4gICAqXG4gICAqIFNldCB0aGUgYGNvbW1hbmRzYCB0byBhbiBlbXB0eSBhcnJheSBpZiB5b3Ugd2FudCB0byBmdWxseSBzcGVjaWZ5XG4gICAqIHRoZSBCdWlsZFNwZWMgdXNpbmcgdGhpcyBmaWVsZC5cbiAgICpcbiAgICogVGhlIEJ1aWxkU3BlYyBtdXN0IGJlIGF2YWlsYWJsZSBpbmxpbmUtLWl0IGNhbm5vdCByZWZlcmVuY2UgYSBmaWxlXG4gICAqIG9uIGRpc2suXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQnVpbGRTcGVjIGNvbXBsZXRlbHkgZGVyaXZlZCBmcm9tIG90aGVyIHByb3BlcnRpZXNcbiAgICovXG4gIHJlYWRvbmx5IHBhcnRpYWxCdWlsZFNwZWM/OiBjb2RlYnVpbGQuQnVpbGRTcGVjO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIHdoZXJlIHRvIGV4ZWN1dGUgdGhlIFNpbXBsZVN5bnRoLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIFZQQ1xuICAgKi9cbiAgcmVhZG9ubHkgdnBjPzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIFdoaWNoIHN1Ym5ldHMgdG8gdXNlLlxuICAgKlxuICAgKiBPbmx5IHVzZWQgaWYgJ3ZwYycgaXMgc3VwcGxpZWQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQWxsIHByaXZhdGUgc3VibmV0cy5cbiAgICovXG4gIHJlYWRvbmx5IHN1Ym5ldFNlbGVjdGlvbj86IGVjMi5TdWJuZXRTZWxlY3Rpb247XG5cbiAgLyoqXG4gICAqIFBvbGljeSBzdGF0ZW1lbnRzIHRvIGFkZCB0byByb2xlIHVzZWQgZHVyaW5nIHRoZSBzeW50aFxuICAgKlxuICAgKiBDYW4gYmUgdXNlZCB0byBhZGQgYWNjZXMgdG8gYSBDb2RlQXJ0aWZhY3QgcmVwb3NpdG9yeSBldGMuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gcG9saWN5IHN0YXRlbWVudHMgYWRkZWQgdG8gQ29kZUJ1aWxkIFByb2plY3QgUm9sZVxuICAgKi9cbiAgcmVhZG9ubHkgcm9sZVBvbGljeVN0YXRlbWVudHM/OiBpYW0uUG9saWN5U3RhdGVtZW50W107XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBleGVjdXRpb24gcm9sZSB0byBiZSB1c2VkIGZvciB0aGUgQ29kZUJ1aWxkIHByb2plY3RcbiAgICpcbiAgICogQGRlZmF1bHQgLSBBIHJvbGUgaXMgYXV0b21hdGljYWxseSBjcmVhdGVkXG4gICAqL1xuICByZWFkb25seSByb2xlPzogaWFtLklSb2xlO1xuXG4gIC8qKlxuICAgKiBDaGFuZ2VzIHRvIGVudmlyb25tZW50XG4gICAqXG4gICAqIFRoaXMgZW52aXJvbm1lbnQgd2lsbCBiZSBjb21iaW5lZCB3aXRoIHRoZSBwaXBlbGluZSdzIGRlZmF1bHRcbiAgICogZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gVXNlIHRoZSBwaXBlbGluZSdzIGRlZmF1bHQgYnVpbGQgZW52aXJvbm1lbnRcbiAgICovXG4gIHJlYWRvbmx5IGJ1aWxkRW52aXJvbm1lbnQ/OiBjb2RlYnVpbGQuQnVpbGRFbnZpcm9ubWVudDtcblxuICAvKipcbiAgICogV2hpY2ggc2VjdXJpdHkgZ3JvdXAgdG8gYXNzb2NpYXRlIHdpdGggdGhlIHNjcmlwdCdzIHByb2plY3QgbmV0d29yayBpbnRlcmZhY2VzLlxuICAgKiBJZiBubyBzZWN1cml0eSBncm91cCBpcyBpZGVudGlmaWVkLCBvbmUgd2lsbCBiZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkuXG4gICAqXG4gICAqIE9ubHkgdXNlZCBpZiAndnBjJyBpcyBzdXBwbGllZC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBTZWN1cml0eSBncm91cCB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY3JlYXRlZC5cbiAgICovXG4gIHJlYWRvbmx5IHNlY3VyaXR5R3JvdXBzPzogZWMyLklTZWN1cml0eUdyb3VwW107XG5cbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgbWludXRlcyBhZnRlciB3aGljaCBBV1MgQ29kZUJ1aWxkIHN0b3BzIHRoZSBidWlsZCBpZiBpdCdzXG4gICAqIG5vdCBjb21wbGV0ZS4gRm9yIHZhbGlkIHZhbHVlcywgc2VlIHRoZSB0aW1lb3V0SW5NaW51dGVzIGZpZWxkIGluIHRoZSBBV1NcbiAgICogQ29kZUJ1aWxkIFVzZXIgR3VpZGUuXG4gICAqXG4gICAqIEBkZWZhdWx0IER1cmF0aW9uLmhvdXJzKDEpXG4gICAqL1xuICByZWFkb25seSB0aW1lb3V0PzogRHVyYXRpb247XG59XG5cbi8qKlxuICogUnVuIGEgc2NyaXB0IGFzIGEgQ29kZUJ1aWxkIFByb2plY3RcbiAqXG4gKiBUaGUgQnVpbGRTcGVjIG11c3QgYmUgYXZhaWxhYmxlIGlubGluZS0taXQgY2Fubm90IHJlZmVyZW5jZSBhIGZpbGVcbiAqIG9uIGRpc2suIElmIHlvdXIgY3VycmVudCBidWlsZCBpbnN0cnVjdGlvbnMgYXJlIGluIGEgZmlsZSBsaWtlXG4gKiBgYnVpbGRzcGVjLnltbGAgaW4geW91ciByZXBvc2l0b3J5LCBleHRyYWN0IHRoZW0gdG8gYSBzY3JpcHRcbiAqIChzYXksIGBidWlsZC5zaGApIGFuZCBpbnZva2UgdGhhdCBzY3JpcHQgYXMgcGFydCBvZiB0aGUgYnVpbGQ6XG4gKlxuICogYGBgdHNcbiAqIG5ldyBwaXBlbGluZXMuQ29kZUJ1aWxkU3RlcCgnU3ludGgnLCB7XG4gKiAgIGNvbW1hbmRzOiBbJy4vYnVpbGQuc2gnXSxcbiAqIH0pO1xuICogYGBgXG4gKi9cbmV4cG9ydCBjbGFzcyBDb2RlQnVpbGRTdGVwIGV4dGVuZHMgU2hlbGxTdGVwIHtcbiAgLyoqXG4gICAqIE5hbWUgZm9yIHRoZSBnZW5lcmF0ZWQgQ29kZUJ1aWxkIHByb2plY3RcbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyB2YWx1ZSBzcGVjaWZpZWQgYXQgY29uc3RydWN0aW9uIHRpbWUsIHVzZSBkZWZhdWx0c1xuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHByb2plY3ROYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIHdoZXJlIHRvIGV4ZWN1dGUgdGhlIFNpbXBsZVN5bnRoLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdnBjPzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIFdoaWNoIHN1Ym5ldHMgdG8gdXNlLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc3VibmV0U2VsZWN0aW9uPzogZWMyLlN1Ym5ldFNlbGVjdGlvbjtcblxuICAvKipcbiAgICogUG9saWN5IHN0YXRlbWVudHMgdG8gYWRkIHRvIHJvbGUgdXNlZCBkdXJpbmcgdGhlIHN5bnRoXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSByb2xlUG9saWN5U3RhdGVtZW50cz86IGlhbS5Qb2xpY3lTdGF0ZW1lbnRbXTtcblxuICAvKipcbiAgICogQ3VzdG9tIGV4ZWN1dGlvbiByb2xlIHRvIGJlIHVzZWQgZm9yIHRoZSBDb2RlQnVpbGQgcHJvamVjdFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcm9sZT86IGlhbS5JUm9sZTtcblxuICAvKipcbiAgICogQnVpbGQgZW52aXJvbm1lbnRcbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyB2YWx1ZSBzcGVjaWZpZWQgYXQgY29uc3RydWN0aW9uIHRpbWUsIHVzZSBkZWZhdWx0c1xuICAgKi9cbiAgcmVhZG9ubHkgYnVpbGRFbnZpcm9ubWVudD86IGNvZGVidWlsZC5CdWlsZEVudmlyb25tZW50O1xuXG4gIC8qKlxuICAgKiBXaGljaCBzZWN1cml0eSBncm91cCB0byBhc3NvY2lhdGUgd2l0aCB0aGUgc2NyaXB0J3MgcHJvamVjdCBuZXR3b3JrIGludGVyZmFjZXMuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHJlYWRvbmx5IHNlY3VyaXR5R3JvdXBzPzogZWMyLklTZWN1cml0eUdyb3VwW107XG5cbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgbWludXRlcyBhZnRlciB3aGljaCBBV1MgQ29kZUJ1aWxkIHN0b3BzIHRoZSBidWlsZCBpZiBpdCdzXG4gICAqIG5vdCBjb21wbGV0ZS4gRm9yIHZhbGlkIHZhbHVlcywgc2VlIHRoZSB0aW1lb3V0SW5NaW51dGVzIGZpZWxkIGluIHRoZSBBV1NcbiAgICogQ29kZUJ1aWxkIFVzZXIgR3VpZGUuXG4gICAqXG4gICAqIEBkZWZhdWx0IER1cmF0aW9uLmhvdXJzKDEpXG4gICAqL1xuICByZWFkb25seSB0aW1lb3V0PzogRHVyYXRpb247XG5cbiAgcHJpdmF0ZSBfcHJvamVjdD86IGNvZGVidWlsZC5JUHJvamVjdDtcbiAgcHJpdmF0ZSBfcGFydGlhbEJ1aWxkU3BlYz86IGNvZGVidWlsZC5CdWlsZFNwZWM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXhwb3J0ZWRWYXJpYWJsZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSBleHBvcnRlZFZhcnNSZW5kZXJlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcsIHByb3BzOiBDb2RlQnVpbGRTdGVwUHJvcHMpIHtcbiAgICBzdXBlcihpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5wcm9qZWN0TmFtZSA9IHByb3BzLnByb2plY3ROYW1lO1xuICAgIHRoaXMuYnVpbGRFbnZpcm9ubWVudCA9IHByb3BzLmJ1aWxkRW52aXJvbm1lbnQ7XG4gICAgdGhpcy5fcGFydGlhbEJ1aWxkU3BlYyA9IHByb3BzLnBhcnRpYWxCdWlsZFNwZWM7XG4gICAgdGhpcy52cGMgPSBwcm9wcy52cGM7XG4gICAgdGhpcy5zdWJuZXRTZWxlY3Rpb24gPSBwcm9wcy5zdWJuZXRTZWxlY3Rpb247XG4gICAgdGhpcy5yb2xlID0gcHJvcHMucm9sZTtcbiAgICB0aGlzLnJvbGVQb2xpY3lTdGF0ZW1lbnRzID0gcHJvcHMucm9sZVBvbGljeVN0YXRlbWVudHM7XG4gICAgdGhpcy5zZWN1cml0eUdyb3VwcyA9IHByb3BzLnNlY3VyaXR5R3JvdXBzO1xuICAgIHRoaXMudGltZW91dCA9IHByb3BzLnRpbWVvdXQ7XG4gIH1cblxuICAvKipcbiAgICogQ29kZUJ1aWxkIFByb2plY3QgZ2VuZXJhdGVkIGZvciB0aGUgcGlwZWxpbmVcbiAgICpcbiAgICogV2lsbCBvbmx5IGJlIGF2YWlsYWJsZSBhZnRlciB0aGUgcGlwZWxpbmUgaGFzIGJlZW4gYnVpbHQuXG4gICAqL1xuICBwdWJsaWMgZ2V0IHByb2plY3QoKTogY29kZWJ1aWxkLklQcm9qZWN0IHtcbiAgICBpZiAoIXRoaXMuX3Byb2plY3QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2FsbCBwaXBlbGluZS5idWlsZFBpcGVsaW5lKCkgYmVmb3JlIHJlYWRpbmcgdGhpcyBwcm9wZXJ0eScpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcHJvamVjdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQ29kZUJ1aWxkIFByb2plY3QncyBwcmluY2lwYWxcbiAgICovXG4gIHB1YmxpYyBnZXQgZ3JhbnRQcmluY2lwYWwoKTogaWFtLklQcmluY2lwYWwge1xuICAgIHJldHVybiB0aGlzLnByb2plY3QuZ3JhbnRQcmluY2lwYWw7XG4gIH1cblxuICAvKipcbiAgICogQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIHRoYXQgY2FuIG9ubHkgYmUgY29uZmlndXJlZCB2aWEgQnVpbGRTcGVjXG4gICAqXG4gICAqIENvbnRhaW5zIGV4cG9ydGVkIHZhcmlhYmxlc1xuICAgKlxuICAgKiBAZGVmYXVsdCAtIENvbnRhaW5zIHRoZSBleHBvcnRlZCB2YXJpYWJsZXNcbiAgICovXG4gIHB1YmxpYyBnZXQgcGFydGlhbEJ1aWxkU3BlYygpOiBjb2RlYnVpbGQuQnVpbGRTcGVjIHwgdW5kZWZpbmVkIHtcbiAgICB0aGlzLmV4cG9ydGVkVmFyc1JlbmRlcmVkID0gdHJ1ZTtcblxuICAgIGNvbnN0IHZhcnNCdWlsZFNwZWMgPSB0aGlzLmV4cG9ydGVkVmFyaWFibGVzLnNpemUgPiAwID8gY29kZWJ1aWxkLkJ1aWxkU3BlYy5mcm9tT2JqZWN0KHtcbiAgICAgIHZlcnNpb246ICcwLjInLFxuICAgICAgZW52OiB7XG4gICAgICAgICdleHBvcnRlZC12YXJpYWJsZXMnOiBBcnJheS5mcm9tKHRoaXMuZXhwb3J0ZWRWYXJpYWJsZXMpLFxuICAgICAgfSxcbiAgICB9KSA6IHVuZGVmaW5lZDtcblxuICAgIHJldHVybiBtZXJnZUJ1aWxkU3BlY3ModmFyc0J1aWxkU3BlYywgdGhpcy5fcGFydGlhbEJ1aWxkU3BlYyk7XG4gIH1cblxuICAvKipcbiAgICogUmVmZXJlbmNlIGEgQ29kZVBpcGVsaW5lIHZhcmlhYmxlIGRlZmluZWQgYnkgdGhlIENvZGVCdWlsZFN0ZXAuXG4gICAqXG4gICAqIFRoZSB2YXJpYWJsZSBtdXN0IGJlIHNldCBpbiB0aGUgc2hlbGwgb2YgdGhlIENvZGVCdWlsZCBzdGVwIHdoZW5cbiAgICogaXQgZmluaXNoZXMgaXRzIGBwb3N0X2J1aWxkYCBwaGFzZS5cbiAgICpcbiAgICogQHBhcmFtIHZhcmlhYmxlTmFtZSB0aGUgbmFtZSBvZiB0aGUgdmFyaWFibGUgZm9yIHJlZmVyZW5jZS5cbiAgICovXG4gIHB1YmxpYyBleHBvcnRlZFZhcmlhYmxlKHZhcmlhYmxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5leHBvcnRlZFZhcnNSZW5kZXJlZCAmJiAhdGhpcy5leHBvcnRlZFZhcmlhYmxlcy5oYXModmFyaWFibGVOYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdleHBvcnRWYXJpYWJsZSgpOiBQaXBlbGluZSBoYXMgYWxyZWFkeSBiZWVuIHByb2R1Y2VkLCBjYW5ub3QgY2FsbCB0aGlzIGZ1bmN0aW9uIGFueW1vcmUnKTtcbiAgICB9XG5cbiAgICB0aGlzLmV4cG9ydGVkVmFyaWFibGVzLmFkZCh2YXJpYWJsZU5hbWUpO1xuXG4gICAgcmV0dXJuIG1ha2VDb2RlUGlwZWxpbmVPdXRwdXQodGhpcywgdmFyaWFibGVOYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGludGVybmFsIHByb2plY3QgdmFsdWVcbiAgICpcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwdWJsaWMgX3NldFByb2plY3QocHJvamVjdDogY29kZWJ1aWxkLklQcm9qZWN0KSB7XG4gICAgdGhpcy5fcHJvamVjdCA9IHByb2plY3Q7XG4gIH1cbn1cbiJdfQ==